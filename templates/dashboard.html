<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Counter Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>

{% if no_active_session %}
  <div class="alert alert-warning text-center fw-bold">
    No active session is currently set.<br/>
    Please wait until a new session is activated or try again later.
  </div>
{% else %}

<body>
  <div class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="text-primary mb-0">My Counter Dashboard</h1>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right"></i> Logout
      </a>
    </div>
    
    <!-- Logged in user info -->
    <div class="text-muted mb-3" style="font-size: 1.1rem;">
        <i class="bi bi-person-circle me-1"></i>
        Logged in as: <strong>{{ username }}</strong>
    </div>
    
{% if active_session %}
  <div class="alert alert-info">
    Current Active Session: <strong>{{ active_session.session_name }}</strong>  </div>
{% else %}
  <div class="alert alert-warning">
    No active session currently set.
  </div>
{% endif %}

    <!-- Counter selector dropdown -->
    <form method="get" action="{{ url_for('home') }}" class="mb-4">
      <label for="counterSelect" class="form-label fw-semibold">Select Counter</label>
      <select id="counterSelect" name="counter_id" class="form-select" onchange="this.form.submit()" required>
        <option value="" disabled {% if not counter %}selected{% endif %}>Choose your counter</option>
        {% for c in counters %}
          <option value="{{ c.id }}" {% if counter and c.id == counter.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <noscript><button type="submit" class="btn btn-primary mt-2">Load Counter</button></noscript>
    </form>

    {% if counter %}
      <h3>Counter: {{ counter.name }}</h3>

<form method="post" action="{{ url_for('update_available_stock', counter_id=counter.id, session_id=active_session.id) }}">
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Item Name</th>
        <!-- <th>Available Stock With Me</th> -->
        <th>Current Available Stock</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td>{{ item.item_name }}</td>
        <!-- <td>{{ item.available_stock or 0 }}</td> -->
        <td>
          {% if counter.name == 'Main Stock' or counter.name == 'Varishtha Vaishnava' %}
          <!-- For specific counter: numeric input from 0 to 10000 -->
          <input 
            type="number" 
            name="available_stock_{{ item.id }}" 
            value="{{ item.available_stock or 0 }}" 
            min="0" 
            max="10000"
            step="0.01"
            style="width:120px;" 
            required 
            class="form-control"
          >
          {% else %}
          <!-- For other counters: radio buttons with 1, 0.75, 0.5, 0.25, 0 -->
          {% set stock_val = item.available_stock|float if item.available_stock is not none else None %}
          <div class="d-flex gap-4">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="available_stock_{{ item.id }}" 
                     id="stock_{{ item.id }}_1" value="1" {% if stock_val == 1.0 %}checked{% endif %} required>
              <label class="form-check-label" for="stock_{{ item.id }}_1">1</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="available_stock_{{ item.id }}" 
                     id="stock_{{ item.id }}_075" value="0.75" {% if stock_val == 0.75 %}checked{% endif %} required>
              <label class="form-check-label" for="stock_{{ item.id }}_075">0.75</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="available_stock_{{ item.id }}" 
                     id="stock_{{ item.id }}_05" value="0.5" {% if stock_val == 0.5 %}checked{% endif %} required>
              <label class="form-check-label" for="stock_{{ item.id }}_05">0.5</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="available_stock_{{ item.id }}" 
                     id="stock_{{ item.id }}_025" value="0.25" {% if stock_val == 0.25 %}checked{% endif %} required>
              <label class="form-check-label" for="stock_{{ item.id }}_025">0.25</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="available_stock_{{ item.id }}" 
                     id="stock_{{ item.id }}_0" value="0" {% if stock_val == 0.0 %}checked{% endif %} required>
              <label class="form-check-label" for="stock_{{ item.id }}_0">0</label>
            </div>
          </div>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3" class="text-center">No items found. Please add new items.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <button type="submit" class="btn btn-primary mb-3">Update Stocks</button>
</form>

    {% else %}
      <p class="text-muted">Please select a counter to manage its available stock.</p>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Get current counter ID and name from the page
    const currentCounterId = {{ counter.id if counter else 'null' }};
    const currentCounterName = {{ counter.name|tojson if counter else 'null' }};
    const currentSessionId = {{ active_session.id if active_session else 'null' }};
    
    // Only enable polling for normal counters (not Main Stock or Varishtha Vaishnava)
    const isSpecialCounter = currentCounterName === 'Main Stock' || currentCounterName === 'Varishtha Vaishnava';
    
    // Poll for stock reset notifications every 5 seconds (only for normal counters)
    let notificationCheckInterval;
    let currentNotificationId = null;

    function checkForResetNotification() {
      if (!currentCounterId || !currentSessionId) {
        return; // No counter or session selected, don't check
      }
      
      fetch('/counter/check_reset_notification/' + currentCounterId + '/' + currentSessionId)
        .then(response => response.json())
        .then(data => {
          // Handle session change notification (yellow banner)
          if (data.session_changed) {
            showSessionChangeBanner(data);
            return;
          }
          
          // Handle stock reset notification (red banner)
          if (data.notification && currentNotificationId !== data.notification_id) {
            currentNotificationId = data.notification_id;
            showResetNotificationBanner(data);
          }
        })
        .catch(error => console.error('Error checking for notifications:', error));
    }

    function showResetNotificationBanner(data) {
      // Remove any existing notification banner
      const existingBanner = document.getElementById('reset-notification-banner');
      if (existingBanner) {
        existingBanner.remove();
      }

      // Create notification banner with responsive styling
      const banner = document.createElement('div');
      banner.id = 'reset-notification-banner';
      banner.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg';
      banner.style.cssText = 'z-index: 9999; width: 75%; max-width: 500px; left: 50%; transform: translateX(-50%);';
      banner.innerHTML = `
        <div class="d-flex flex-column align-items-center text-center">
          <div class="mb-2">
            <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
            <strong style="font-size: 1.1rem;">Stock Reset Alert!</strong>
          </div>
          <p class="mb-3 small">${data.message}</p>
          <button type="button" class="btn btn-primary btn-sm w-100" onclick="refreshPage(${data.notification_id})" style="max-width: 200px;">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Now
          </button>
        </div>
      `;

      document.body.insertBefore(banner, document.body.firstChild);
    }

    function showSessionChangeBanner(data) {
      // Remove any existing session change banner
      const existingBanner = document.getElementById('session-change-banner');
      if (existingBanner) {
        existingBanner.remove();
      }
      // Create session change banner with yellow/warning styling
      const banner = document.createElement('div');
      banner.id = 'session-change-banner';
      banner.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg';
      banner.style.cssText = 'z-index: 9999; width: 75%; max-width: 500px; left: 50%; transform: translateX(-50%);';
      banner.innerHTML = `
        <div class="d-flex flex-column align-items-center text-center">
          <div class="mb-2">
            <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;"></i>
            <strong style="font-size: 1.1rem;">Session Changed!</strong>
          </div>
          <p class="mb-3 small">${data.message}</p>
          <button type="button" class="btn btn-warning btn-sm w-100" onclick="window.location.reload()" style="max-width: 200px;">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Now
          </button>
        </div>
      `;

      document.body.insertBefore(banner, document.body.firstChild);
      
      // Stop checking for further notifications since session has changed
      if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval);
      }
    }

    function refreshPage(notificationId) {
      // Acknowledge notification for this counter, then refresh
      fetch('/counter/acknowledge_reset/' + notificationId + '/' + currentCounterId, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      }).then(() => {
        window.location.reload();
      });
    }

    // Start polling when page loads (only for normal counters)
    document.addEventListener('DOMContentLoaded', function() {
      if (currentCounterId && !isSpecialCounter) {
        console.log('Starting notification polling for counter:', currentCounterName);
        checkForResetNotification(); // Check immediately
        notificationCheckInterval = setInterval(checkForResetNotification, 5000); // Then every 5 seconds
      } else if (isSpecialCounter) {
        console.log('Skipping notification polling for special counter:', currentCounterName);
      }
    });

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function() {
      if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval);
      }
    });
  </script>
</body>

{% endif %}
</html>
