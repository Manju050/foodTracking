{% extends "admin_base.html" %}

{% block title %}Manage Counters{% endblock %}

{% block extra_styles %}
<style>
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  
  .dropdown-menu .dropdown-item {
    padding: 0.4rem 0.8rem;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
    font-size: 0.85rem;
  }
  
  .dropdown-menu .dropdown-item:hover {
    background-color: #f8f9fa;
  }
  
  .dropdown-toggle::after {
    margin-left: 0.3em;
  }
  
  .user-list {
    max-height: 180px;
    overflow-y: auto;
  }
  
  /* Add spacing between username and dropdown button */
  .gap-3 {
    gap: 1rem !important;
  }
  
</style>
{% endblock %}

{% block content %}
  <div class="modal fade" id="counterDetailsModal" tabindex="-1" aria-labelledby="counterDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="counterDetailsLabel">Counter Stock Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="counterDetailsBody">
          <p>Loading counter items...</p>
        </div>
      </div>
    </div>
  </div>

  <h2 class="text-left text-primary fw-bold my-4" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
    MANAGE COUNTERS
  </h2>

    <form method="post" class="mb-4 p-4 bg-light rounded shadow-sm border border-primary">
      <div class="row g-3 align-items-center">
        <div class="col-md-5">
          <input type="text" name="counter_name" placeholder="Counter Name" required class="form-control border border-info" />
        </div>
        <div class="col-md-5">
          <input type="text" name="username" id="username-input" placeholder="Assign to Username" required class="form-control border border-warning" autocomplete="off"/>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100 px-4 fw-semibold">
            <i class="bi bi-plus-circle me-2"></i> Add
          </button>
        </div>
      </div>
    </form>

    <h2 class="text-left text-primary fw-bold mb-4" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
      EXISTING COUNTERS
    </h2>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Counter ID</th>
          <th>Counter Name</th>
          <th>Assigned User</th>
          <th>User ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for counter in counters %}
        <tr class="counter-row" data-counter-id="{{ counter.id }}" style="cursor: pointer;">
          <td>{{ counter.id }}</td>
          <td>{{ counter.name }}</td>
          <td>
            <!-- Searchable dropdown to change the assigned user. The dropdown doesn't show default admin and current assigned user -->
            <!-- The selection can be cleared by clicking the "x" icon next to the selected username. -->
            <div class="d-flex align-items-center gap-3">
              <span>{{ counter.user.username if counter.user else '—' }}</span>
              <div class="dropdown position-relative" style="display: inline-block;">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                        type="button" 
                        data-counter-id="{{ counter.id }}"
                        data-current-user-id="{{ counter.user.id if counter.user else '' }}"
                        onclick="toggleDropdown(event, this)"
                        style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                  Change user
                </button>
                <div class="dropdown-menu p-2" style="display: none; min-width: 180px; max-height: 250px; overflow-y: auto;">
                  <input type="text" 
                         class="form-control form-control-sm mb-2" 
                         placeholder="Search users..." 
                         onkeyup="filterUsers(this)"
                         onclick="event.stopPropagation()"
                         style="font-size: 0.85rem;">
                  <ul class="list-unstyled mb-0 user-list">
                    {% for user in users %}
                      {# Show all users except the default 'admin' user and the currently assigned user #}
                      {% if user.username != 'admin' and (not counter.user or user.id != counter.user.id) %}
                      <li>
                        <a class="dropdown-item" 
                           href="#" 
                           data-user-id="{{ user.id }}"
                           data-username="{{ user.username }}"
                           onclick="selectUser(event, this)"
                           style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                          {{ user.username }}
                        </a>
                      </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </td>
          <td>{{ counter.user.id if counter.user else '—' }}</td>
          <td>
            <form method="post" action="{{ url_for('delete_counter', counter_id=counter.id) }}" onsubmit="return confirm('Are you sure you want to delete this counter?');" onclick="event.stopPropagation();">
              <button type="submit" class="btn btn-sm btn-danger">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <form id="update-counter-form" method="post" action="{{ url_for('update_multiple_counter_users') }}" style="display: none;">
      <div id="counter-updates-container"></div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle me-2"></i> Update All Changes
      </button>
    </form>

    <div class="mb-4"></div>

{% endblock %}

{% block extra_scripts %}
  <script>
    // This script handles username autocomplete suggestions
    document.addEventListener('DOMContentLoaded', function () {
      const input = document.getElementById('username-input');
      let timeout = null;

      input.addEventListener('input', function() {
        clearTimeout(timeout);

        timeout = setTimeout(() => {
          const query = input.value.trim();
          if (query.length < 1) {
            closeSuggestions();
            return;
          }

          fetch(`/admin/user_suggestions?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
              showSuggestions(data);
            });
        }, 300);
      });

      function showSuggestions(usernames) {
        closeSuggestions();
        if (!usernames.length) return;

        const list = document.createElement('ul');
        list.className = 'list-group position-absolute';
        list.style.zIndex = 1050;
        list.style.width = input.offsetWidth + 'px';

        usernames.forEach(name => {
          const item = document.createElement('li');
          item.className = 'list-group-item list-group-item-action';
          item.textContent = name;
          item.style.cursor = 'pointer';

          item.addEventListener('click', () => {
            input.value = name;
            closeSuggestions();
          });

          list.appendChild(item);
        });

        input.parentNode.style.position = 'relative';
        input.parentNode.appendChild(list);
      }

      function closeSuggestions() {
        const oldList = document.querySelector('#username-input + ul.list-group');
        if (oldList) oldList.remove();
      }

      document.addEventListener('click', function(e) {
        if (!input.contains(e.target)) closeSuggestions();
      });
    });

    // New dropdown functionality for changing counter users
    let currentOpenDropdown = null;
    let counterChanges = {}; // Track multiple counter changes: {counterId: {userId, username}}

    function toggleDropdown(event, button) {
      event.stopPropagation();
      
      const dropdown = button.nextElementSibling;
      const isCurrentlyOpen = dropdown.style.display === 'block';
      
      // Close all dropdowns first
      closeAllDropdowns();
      
      // If it wasn't open, open it
      if (!isCurrentlyOpen) {
        dropdown.style.display = 'block';
        currentOpenDropdown = dropdown;
        
        // Reset search input
        const searchInput = dropdown.querySelector('input[type="text"]');
        if (searchInput) {
          searchInput.value = '';
          filterUsers(searchInput);
        }
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      currentOpenDropdown = null;
    }

    function filterUsers(input) {
      const filter = input.value.toLowerCase();
      const dropdown = input.closest('.dropdown-menu');
      const items = dropdown.querySelectorAll('.user-list li');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(filter)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function selectUser(event, link) {
      event.preventDefault();
      event.stopPropagation();
      
      const userId = link.getAttribute('data-user-id');
      const username = link.getAttribute('data-username');
      const dropdown = link.closest('.dropdown-menu');
      const button = dropdown.previousElementSibling;
      const counterId = button.getAttribute('data-counter-id');
      const currentUserId = button.getAttribute('data-current-user-id');
      
      // Only track change if user selected is different from current user
      if (userId !== currentUserId) {
        // Store this counter change
        counterChanges[counterId] = {
          userId: userId,
          username: username,
          button: button
        };
        
        // Highlight the button to show selection with clear option
        button.classList.add('btn-primary');
        button.classList.remove('btn-outline-secondary');
        button.innerHTML = `Change to: ${username} <i class="bi bi-x-circle ms-1" onclick="clearSelection(event, ${counterId})" style="cursor: pointer;"></i>`;
        
        // Update the form with all pending changes
        updateFormWithChanges();
        
        // Show the update button
        const updateForm = document.getElementById('update-counter-form');
        updateForm.style.display = 'block';
      }
      
      closeAllDropdowns();
    }

    function clearSelection(event, counterId) {
      event.stopPropagation();
      event.preventDefault();
      
      // Remove this counter from pending changes
      if (counterChanges[counterId]) {
        const button = counterChanges[counterId].button;
        
        // Reset button to original state
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-secondary');
        button.textContent = 'Change user';
        
        // Remove from changes object
        delete counterChanges[counterId];
        
        // Update form
        if (Object.keys(counterChanges).length > 0) {
          updateFormWithChanges();
        } else {
          // Hide update button if no changes remain
          const updateForm = document.getElementById('update-counter-form');
          updateForm.style.display = 'none';
        }
      }
    }

    function updateFormWithChanges() {
      const container = document.getElementById('counter-updates-container');
      container.innerHTML = ''; // Clear existing inputs
      
      // Add hidden inputs for each counter change
      Object.keys(counterChanges).forEach(counterId => {
        const change = counterChanges[counterId];
        
        const counterInput = document.createElement('input');
        counterInput.type = 'hidden';
        counterInput.name = 'counter_ids';
        counterInput.value = counterId;
        container.appendChild(counterInput);
        
        const userInput = document.createElement('input');
        userInput.type = 'hidden';
        userInput.name = 'user_ids';
        userInput.value = change.userId;
        container.appendChild(userInput);
      });
      
      // Update button text to show number of changes
      const changeCount = Object.keys(counterChanges).length;
      const submitBtn = document.querySelector('#update-counter-form button[type="submit"]');
      if (changeCount === 1) {
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Update 1 Counter';
      } else {
        submitBtn.innerHTML = `<i class="bi bi-check-circle me-2"></i> Update ${changeCount} Counters`;
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown')) {
        closeAllDropdowns();
      }
    });

    // Prevent dropdown from closing when clicking inside it
    document.addEventListener('click', function(event) {
      if (event.target.closest('.dropdown-menu')) {
        event.stopPropagation();
      }
    });

    // This script handles counter row click events and session check
    document.addEventListener('DOMContentLoaded', () => {
      // Determine whether session is active (template renders 'true' or 'false')
      const sessionActive = '{{ session_active | lower }}' === 'true';

      // Function to show alert about no active session
      function showNoSessionAlert() {
        const container = document.querySelector('.container');
        const existingAlert = document.querySelector('#no-session-alert');
        if (!existingAlert) {
          const alertDiv = document.createElement('div');
          alertDiv.id = 'no-session-alert';
          alertDiv.className = 'alert alert-warning alert-dismissible fade show';
          alertDiv.role = 'alert';
          alertDiv.innerHTML = `
            No active session. Please start a session to view counter details.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          container.prepend(alertDiv);
        }
      }

      const counterRows = document.querySelectorAll('.counter-row');
      const counterModal = new bootstrap.Modal(document.getElementById('counterDetailsModal'));
      const counterModalBody = document.getElementById('counterDetailsBody');
      const currentSessionName = '{{ current_session_name }}';

      counterRows.forEach(row => {
        row.addEventListener('click', async () => {
          if (!sessionActive) {
            showNoSessionAlert();
            return; // Prevent modal opening if no session
          }

          const counterId = row.getAttribute('data-counter-id');
          counterModalBody.innerHTML = '<p>Loading counter items...</p>';
          counterModal.show();

          try {
            const response = await fetch(`/admin/counter_items/${counterId}`);
            if (!response.ok) throw new Error('Failed to load counter items.');
            const data = await response.json();

            if (!data.items || data.items.length === 0) {
              counterModalBody.innerHTML = '<p>No items found for this counter.</p>';
              return;
            }

            let html = `<table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>Item Name</th>
                              <th>Available Stock</th>
                              <th>Session Name</th>
                            </tr>
                          </thead>
                          <tbody>`;

            data.items.forEach(item => {
              html += `<tr>
                        <td>${item.item_name}</td>
                        <td>${item.available_stock}</td>
                        <td>${item.session_name}</td>
                      </tr>`;
            });

            html += '</tbody></table>';

            counterModalBody.innerHTML = html;
          } catch (error) {
            counterModalBody.innerHTML = `<p class="text-danger">${error.message}</p>`;
          }
        });
      });
    });
  </script>
{% endblock %}
